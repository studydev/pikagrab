const square = document.getElementById('square');
let playerName = '';
const userNameDisplay = document.getElementById('userNameDisplay');
const changeUserBtn = document.getElementById('changeUserBtn');
const nameInputModal = document.getElementById('nameInputModal');
const playerNameInput = document.getElementById('playerNameInput');
const nameSubmitBtn = document.getElementById('nameSubmitBtn');
let gameActive = false;
const rankingBoard = document.getElementById('rankingBoard');
const rankingList = document.getElementById('rankingList');

let hitCount = 0;
const maxHit = 5;
const heartsDiv = document.getElementById('hearts');
const gameOverDiv = document.getElementById('gameOver');
const restartBtn = document.getElementById('restartBtn');

// Ï†êÏàò Í¥ÄÎ†® Î≥ÄÏàò Î∞è ÏöîÏÜå Ï∂îÍ∞Ä
let score = 0;
const scoreBoard = document.getElementById('scoreBoard');

// Ïù¥Ïä§ÌÑ∞ÏóêÍ∑∏: ÏûëÏùÄ ÎÑ§Î™® 7Î≤à ÌÅ¥Î¶≠ Ïãú 777Ï†ê Ï∂îÍ∞Ä
const easterEggBox = document.getElementById('easterEggBox');
let easterEggClickCount = 0;
easterEggBox.addEventListener('click', function() {
    easterEggClickCount++;
    if (easterEggClickCount === 7) {
        score += 777;
        updateScore();
        easterEggClickCount = 0;
        // ÏÇ¥Ïßù Ìö®Í≥º
        easterEggBox.style.opacity = '1';
        setTimeout(() => { easterEggBox.style.opacity = '0.3'; }, 500);
    }
});

// Ïù¥Î¶Ñ ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú Î∞è Ï≤òÎ¶¨
function showNameInputModal() {
    nameInputModal.style.display = 'flex';
    playerNameInput.value = '';
    playerNameInput.focus();
}

function hideNameInputModal() {
    nameInputModal.style.display = 'none';
}

function startGameWithName() {
    const name = playerNameInput.value.trim();
    if (!name) {
        alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
    gameActive = false;
        playerNameInput.focus();
        return;
    }
    playerName = name;
    hideNameInputModal();
    // square, pika1, pika2 Î≥¥Ïù¥Í∏∞
    document.getElementById('square').style.display = 'block';
    document.getElementById('pika1').style.display = 'block';
    document.getElementById('pika2').style.display = 'block';
    // ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÌëúÏãú
    userNameDisplay.textContent = `üë§ ${playerName}`;
    userNameDisplay.style.display = 'block';
    restartGame();
    rankingBoard.style.display = 'block';
    fetchAndShowRanking();
}

nameSubmitBtn.addEventListener('click', startGameWithName);
playerNameInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') startGameWithName();
});

// Í≤åÏûÑ ÏßÑÏûÖ Ïãú Ïù¥Î¶Ñ ÏûÖÎ†• Í∞ïÏ†ú
window.addEventListener('DOMContentLoaded', () => {
    // square, pika1, pika2 Ïà®Í∏∞Í∏∞ (ÏÉàÎ°úÍ≥†Ïπ® Ïãú)
    document.getElementById('square').style.display = 'none';
    document.getElementById('pika1').style.display = 'none';
    document.getElementById('pika2').style.display = 'none';
    userNameDisplay.style.display = 'none';
    showNameInputModal();
    gameActive = true;
});

// ÏÇ¨Ïö©Ïûê ÍµêÏ≤¥ Î≤ÑÌäº ÎèôÏûë (Ï§ëÎ≥µ Îì±Î°ù Î∞©ÏßÄ)
changeUserBtn.addEventListener('click', () => {
    // Í≤åÏûÑ ÌôîÎ©¥ ÏöîÏÜå Ïà®Í∏∞Í∏∞
    document.getElementById('square').style.display = 'none';
    document.getElementById('pika1').style.display = 'none';
    document.getElementById('pika2').style.display = 'none';
    userNameDisplay.style.display = 'none';
    gameActive = false;
    showNameInputModal();
});
const pika1 = document.getElementById('pika1');
const pika2 = document.getElementById('pika2');
let x = 0;
let y = 0;
const step = 20;

// Îëê pikaÎ•º Î∞∞Ïó¥Î°ú Í¥ÄÎ¶¨
const pikas = [pika1, pika2];

function placePikaRandom(pika) {
    const max = 360;
    const pikaX = Math.floor(Math.random() * (max / step + 1)) * step;
    const pikaY = Math.floor(Math.random() * (max / step + 1)) * step;
    pika.style.left = pikaX + 'px';
    pika.style.top = pikaY + 'px';
    pika.style.display = 'block';
}

function isCatch(pika) {
    const squareRect = square.getBoundingClientRect();
    const pikaRect = pika.getBoundingClientRect();
    return !(
        squareRect.right < pikaRect.left ||
        squareRect.left > pikaRect.right ||
        squareRect.bottom < pikaRect.top ||
        squareRect.top > pikaRect.bottom
    );
}

// Îëê pika Î™®Îëê ÎûúÎç§ ÏúÑÏπòÏóê ÎÜìÍ∏∞
pikas.forEach(placePikaRandom);

// ÎßàÏö∞Ïä§/ÌÑ∞Ïπò ÎìúÎûòÍ∑∏Î°ú ÎÑ§Î™® ÏõÄÏßÅÏù¥Í∏∞
let isDragging = false;
let offsetX = 0;
let offsetY = 0;
let lastX = 0, lastY = 0;

// ÎßàÏö∞Ïä§ Ïù¥Î≤§Ìä∏
square.addEventListener('mousedown', function(e) {
    isDragging = true;
    offsetX = e.clientX - square.offsetLeft;
    offsetY = e.clientY - square.offsetTop;
});

document.addEventListener('mousemove', function(e) {
    if (isDragging) {
        let newX = e.clientX - offsetX;
        let newY = e.clientY - offsetY;
        newX = Math.max(0, Math.min(360, newX));
        newY = Math.max(0, Math.min(360, newY));
        square.style.left = newX + 'px';
        square.style.top = newY + 'px';
        x = newX;
        y = newY;

        // 3D Ìö®Í≥º Î∞©Ìñ• Í≥ÑÏÇ∞
        setSquare3DEffect(Math.sign(newX - lastX), Math.sign(newY - lastY));
        lastX = newX;
        lastY = newY;
    }
});

document.addEventListener('mouseup', function() {
    isDragging = false;
    // Î©àÏ∂îÎ©¥ ÏõêÎûòÎåÄÎ°ú
    square.style.transform = 'perspective(300px) rotateX(0deg) rotateY(0deg)';
});

// ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏
square.addEventListener('touchstart', function(e) {
    isDragging = true;
    const touch = e.touches[0];
    offsetX = touch.clientX - square.offsetLeft;
    offsetY = touch.clientY - square.offsetTop;
    e.preventDefault();
});

document.addEventListener('touchmove', function(e) {
    if (isDragging) {
        const touch = e.touches[0];
        let newX = touch.clientX - offsetX;
        let newY = touch.clientY - offsetY;
        newX = Math.max(0, Math.min(360, newX));
        newY = Math.max(0, Math.min(360, newY));
        square.style.left = newX + 'px';
        square.style.top = newY + 'px';
        x = newX;
        y = newY;
        e.preventDefault();
    }
});

document.addEventListener('touchend', function() {
    isDragging = false;
});

// ÎßàÏö∞Ïä§/ÌÑ∞Ïπò ÎìúÎûòÍ∑∏ ÏΩîÎìúÎäî Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©

// Ïö∞ÌÅ¥Î¶≠ Ïãú Ï¥ùÏïå Î∞úÏÇ¨ (Îëê pika Î™®Îëê ÎßûÏ∂ú Ïàò ÏûàÍ≤å)
document.getElementById('gameArea').addEventListener('contextmenu', function(e) {
    e.preventDefault();

    const bullet = document.createElement('div');
    bullet.className = 'bullet';
    bullet.style.background = 'blue'; // ‚òÖ ÌååÎûÄÏÉâ Ï¥ùÏïåÎ°ú Î≥ÄÍ≤Ω!
    const gameAreaRect = this.getBoundingClientRect();
    const squareRect = square.getBoundingClientRect();
    const startX = squareRect.left - gameAreaRect.left + squareRect.width / 2 - 5;
    const startY = squareRect.top - gameAreaRect.top + squareRect.height / 2 - 5;
    bullet.style.left = startX + 'px';
    bullet.style.top = startY + 'px';
    this.appendChild(bullet);

    const targetX = e.clientX - gameAreaRect.left;
    const targetY = e.clientY - gameAreaRect.top;
    const dx = targetX - (startX + 5);
    const dy = targetY - (startY + 5);
    const distance = Math.sqrt(dx * dx + dy * dy);
    const speed = 5;
    const vx = dx / distance * speed;
    const vy = dy / distance * speed;

    let bulletX = startX;
    let bulletY = startY;

    function moveBullet() {
        bulletX += vx;
        bulletY += vy;
        bullet.style.left = bulletX + 'px';
        bullet.style.top = bulletY + 'px';

        // Îëê pika Ï§ë ÌïòÎÇòÎùºÎèÑ ÎßûÏúºÎ©¥
        for (const pika of pikas) {
            const bulletRect = bullet.getBoundingClientRect();
            const pikaRect = pika.getBoundingClientRect();
            if (
                bulletRect.right > pikaRect.left &&
                bulletRect.left < pikaRect.right &&
                bulletRect.bottom > pikaRect.top &&
                bulletRect.top < pikaRect.bottom &&
                pika.style.display !== 'none'
            ) {
                pika.style.display = 'none';
                // 1% ÌôïÎ•†Î°ú 1000Ï†ê, ÏïÑÎãàÎ©¥ 1Ï†ê
                if (Math.random() < 0.01) {
                    score += 1000;
                } else {
                    score += 1;
                }
                updateScore();        // Ï†êÏàòÌåê ÏóÖÎç∞Ïù¥Ìä∏
                setTimeout(() => placePikaRandom(pika), 1000);
                bullet.remove();
                return;
            }
        }

        if (
            bulletX < 0 || bulletX > 390 ||
            bulletY < 0 || bulletY > 390
        ) {
            bullet.remove();
            return;
        }

        requestAnimationFrame(moveBullet);
    }

    moveBullet();
});

// pikaÍ∞Ä 1Ï¥àÎßàÎã§ Ï¥ùÏïå Î∞úÏÇ¨ (Í∞ÅÍ∞Å Îî∞Î°ú)
function firePikaBullet(pika) {
    if (pika.style.display === 'none') {
        // Ï†êÏàòÏóê Îî∞Îùº Î∞úÏÇ¨ Í∞ÑÍ≤©ÏùÑ Ï§ÑÏûÑ (ÏµúÏÜå 500ms)
        const interval = Math.max(500, 1000 - score * 5);
        setTimeout(() => firePikaBullet(pika), interval);
        return;
    }

    const bullet = document.createElement('div');
    bullet.className = 'bullet';
    bullet.style.background = 'red';
    const gameArea = document.getElementById('gameArea');
    const gameAreaRect = gameArea.getBoundingClientRect();
    const pikaRect = pika.getBoundingClientRect();
    const startX = pikaRect.left - gameAreaRect.left + pikaRect.width / 2 - 5;
    const startY = pikaRect.top - gameAreaRect.top + pikaRect.height / 2 - 5;
    bullet.style.left = startX + 'px';
    bullet.style.top = startY + 'px';
    gameArea.appendChild(bullet);

    // ÎûúÎç§ Î∞©Ìñ•
    const angle = Math.random() * 2 * Math.PI;
    const speed = 5;
    const vx = Math.cos(angle) * speed;
    const vy = Math.sin(angle) * speed;

    let bulletX = startX;
    let bulletY = startY;

    function moveBullet() {
        bulletX += vx;
        bulletY += vy;
        bullet.style.left = bulletX + 'px';
        bullet.style.top = bulletY + 'px';

        const bulletRect = bullet.getBoundingClientRect();
        const squareRect = square.getBoundingClientRect();
        if (
            bulletRect.right > squareRect.left &&
            bulletRect.left < squareRect.right &&
            bulletRect.bottom > squareRect.top &&
            bulletRect.top < squareRect.bottom &&
            square.style.display !== 'none'
        ) {
            pikaBulletHitSquare(); // ‚Üê Ïù¥ Ìï®ÏàòÍ∞Ä Î∞òÎìúÏãú Ïó¨Í∏∞ÏÑúÎßå Ïã§ÌñâÎêòÏñ¥Ïïº Ìï¥Ïöî!
            bullet.remove();
            return;
        }

        if (
            bulletX < 0 || bulletX > 390 ||
            bulletY < 0 || bulletY > 390
        ) {
            bullet.remove();
            return;
        }

        requestAnimationFrame(moveBullet);
    }

    moveBullet();

    // Ï†êÏàòÏóê Îî∞Îùº Î∞úÏÇ¨ Í∞ÑÍ≤©ÏùÑ Ï§ÑÏûÑ (ÏµúÏÜå 10ms)
    const interval = Math.max(10, 1000 - score * 5);
    setTimeout(() => firePikaBullet(pika), interval);
}

// Îëê pika Î™®Îëê Ï¥ùÏïå Î∞úÏÇ¨ ÏãúÏûë
pikas.forEach(firePikaBullet);

// 3D Ìö®Í≥º Ìï®Ïàò Ï∂îÍ∞Ä
function setSquare3DEffect(dx, dy) {
    // dx, dyÎäî -1, 0, 1 Í∞í (Î∞©Ìñ•)
    const rotateY = dx * 20; // Ï¢åÏö∞ Ïù¥ÎèôÏãú YÏ∂ï ÌöåÏ†Ñ
    const rotateX = dy * -20; // ÏÉÅÌïò Ïù¥ÎèôÏãú XÏ∂ï ÌöåÏ†Ñ
    square.style.transform = `perspective(300px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
}

// ÌïòÌä∏ ÌëúÏãú Ìï®Ïàò
function updateHearts() {
    let hearts = '';
    for (let i = 0; i < maxHit - hitCount; i++) {
        hearts += '‚ù§Ô∏è';
    }
    for (let i = 0; i < hitCount; i++) {
        hearts += 'ü§ç';
    }
    heartsDiv.innerHTML = hearts;
}

// Ï†êÏàòÌåê ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
function updateScore() {
    scoreBoard.textContent = `Ï†êÏàò: ${score}`;
}

// Í≤åÏûÑ Ïò§Î≤Ñ Ï≤òÎ¶¨ Ìï®Ïàò
async function gameOver() {
    gameOverDiv.style.display = 'block';
    square.style.display = 'none';
    pikas.forEach(pika => pika.style.display = 'none');
    heartsDiv.style.display = 'none';
    // Ï†êÏàò upsert
    if (playerName) {
        await window.upsertScore(playerName, score);
        fetchAndShowRanking();
    }
}

// Îã§ÏãúÌïòÍ∏∞ Ìï®Ïàò
function restartGame() {
    hitCount = 0;
    score = 0; // Ï†êÏàò Ï¥àÍ∏∞Ìôî
    gameOverDiv.style.display = 'none';
    square.style.display = 'block';
    heartsDiv.style.display = 'block';
    pikas.forEach(placePikaRandom);
    pikas.forEach(pika => pika.style.display = 'block');
    updateHearts();
    updateScore(); // Ï†êÏàòÌåê Ï¥àÍ∏∞Ìôî
    fetchAndShowRanking();
}
// Îû≠ÌÇπ Î≥¥Îìú ÌëúÏãú Ìï®Ïàò
async function fetchAndShowRanking() {
    const { data, error } = await window.fetchTop10();
    if (error) {
        rankingList.innerHTML = '<div>Îû≠ÌÇπÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>';
        return;
    }
    let html = `<table style="width:100%;border-collapse:collapse;text-align:center;table-layout:fixed;">
        <thead><tr style="background:#ffe082;"><th style="width:20%">ÏàúÏúÑ</th><th style="width:50%">Ïù¥Î¶Ñ</th><th style="width:30%">Ï†êÏàò</th></tr></thead><tbody>`;
    data.forEach((row, idx) => {
        const highlight = row.name === playerName ? ' style="color:#d2691e;font-weight:bold;background:#fff3c0;"' : '';
        html += `<tr${highlight}><td>${idx+1}</td><td>${row.name}</td><td>${row.score}</td></tr>`;
    });
    html += '</tbody></table>';
    rankingList.innerHTML = html;
}

// Îã§ÏãúÌïòÍ∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
restartBtn.addEventListener('click', restartGame);

// ÌîºÏπ¥ Ï¥ùÏïåÏù¥ Ï∫êÎ¶≠ÌÑ∞Ïóê ÎßûÏïòÏùÑ Îïå
function pikaBulletHitSquare() {
    hitCount += 1;
    updateHearts();
    updateScore(); // Ï†êÏàòÌåê ÏóÖÎç∞Ïù¥Ìä∏
    if (hitCount >= maxHit) {
        gameOver();
    }
}

// Í≤åÏûÑ ÏãúÏûë Ïãú ÌïòÌä∏ Î∞è Ï†êÏàò ÌëúÏãú
updateHearts();
updateScore();

const gameArea = document.getElementById('gameArea');

function fireCharacterBulletTo(x, y) {
    const bullet = document.createElement('div');
    bullet.className = 'bullet';
    bullet.style.background = 'blue';
    const gameAreaRect = gameArea.getBoundingClientRect();
    const squareRect = square.getBoundingClientRect();
    const startX = squareRect.left - gameAreaRect.left + squareRect.width / 2 - 5;
    const startY = squareRect.top - gameAreaRect.top + squareRect.height / 2 - 5;
    bullet.style.left = startX + 'px';
    bullet.style.top = startY + 'px';
    gameArea.appendChild(bullet);

    const dx = x - (startX + 5);
    const dy = y - (startY + 5);
    const distance = Math.sqrt(dx * dx + dy * dy);
    const speed = 5;
    const vx = dx / distance * speed;
    const vy = dy / distance * speed;

    let bulletX = startX;
    let bulletY = startY;

    function moveBullet() {
        bulletX += vx;
        bulletY += vy;
        bullet.style.left = bulletX + 'px';
        bullet.style.top = bulletY + 'px';

        for (const pika of pikas) {
            const bulletRect = bullet.getBoundingClientRect();
            const pikaRect = pika.getBoundingClientRect();
            if (
                bulletRect.right > pikaRect.left &&
                bulletRect.left < pikaRect.right &&
                bulletRect.bottom > pikaRect.top &&
                bulletRect.top < pikaRect.bottom &&
                pika.style.display !== 'none'
            ) {
                pika.style.display = 'none';
                // 0.1% ÌôïÎ•†Î°ú 100Ï†ê, ÏïÑÎãàÎ©¥ 1Ï†ê
                if (Math.random() < 0.001) {
                    score += 100;
                } else {
                    score += 1;
                }
                updateScore();
                setTimeout(() => placePikaRandom(pika), 1000);
                bullet.remove();
                return;
            }
        }

        if (
            bulletX < 0 || bulletX > 390 ||
            bulletY < 0 || bulletY > 390
        ) {
            bullet.remove();
            return;
        }

        requestAnimationFrame(moveBullet);
    }

    moveBullet();
}

// Ï∫êÎ¶≠ÌÑ∞ Ïô∏Í≥Ω 40pxÏóêÏÑú ÌÑ∞Ïπò/ÌÅ¥Î¶≠ Ïãú Ï¥ùÏïå Î∞úÏÇ¨
gameArea.addEventListener('click', function(e) {
    // Î™®Î∞îÏùº ÌÑ∞ÏπòÎèÑ click Ïù¥Î≤§Ìä∏Î°ú ÎèôÏûëÌï®
    const gameAreaRect = gameArea.getBoundingClientRect();
    const squareRect = square.getBoundingClientRect();
    const clickX = e.clientX - gameAreaRect.left;
    const clickY = e.clientY - gameAreaRect.top;
    const squareCenterX = squareRect.left - gameAreaRect.left + squareRect.width / 2;
    const squareCenterY = squareRect.top - gameAreaRect.top + squareRect.height / 2;

    // Ï∫êÎ¶≠ÌÑ∞ Ï§ëÏã¨ÏóêÏÑú 40px Ïù¥ÏÉÅ Îñ®Ïñ¥ÏßÑ Í≥≥Îßå Ï¥ùÏïå Î∞úÏÇ¨
    const dist = Math.sqrt(
        Math.pow(clickX - squareCenterX, 2) +
        Math.pow(clickY - squareCenterY, 2)
    );
    if (dist > 40) {
        fireCharacterBulletTo(clickX, clickY);
    }
});